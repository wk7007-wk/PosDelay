# PosDelay 프로젝트 규칙

## 앱 개요
배민/쿠팡 광고 자동화 + 주문 지연처리. 주문 건수에 따라 광고 입찰/ON/OFF 자동 조절.

## 개발 방침
- **백그라운드 실행 필수**: 모든 기능은 백그라운드에서도 동작해야 함. 앱 열릴 때만 적용되면 의미 없음. LiveData `observe(this)` 사용 금지 → `observeForever` + onDestroy에서 remove. WebView JS 타이머 의존 금지 → 네이티브 포그라운드 서비스에서 처리
- **웹 로그 분석 → 개선이 핵심 역할**: 웹 대시보드에서 로그를 분석하여 자동화 로직을 개선하는 구조 우선
- **네이티브 최소화, 웹 동기화 우선**: 네이티브 코드는 최대한 줄이고, 웹으로 동기화(Firebase)되는 방식 위주로 코딩
- **안정성 + 리미트 최우선**: Firebase 호출 횟수, API rate limit 등 리미트 관리와 안정성을 항상 최우선. 기능보다 안정성 우선

## 빌드/배포 (코딩 완료 후 반드시 전부 수행)
1. 빌드: `./gradlew assembleDebug`
2. APK 복사: `cp app/build/outputs/apk/debug/app-debug.apk /sdcard/Download/PosDelay.apk`
3. 설치 실행: `termux-open /sdcard/Download/PosDelay.apk`
4. Git 커밋 + 푸시
5. GitHub Release: `gh release create "v${VER}" ... --repo wk7007-wk/PosDelay`
6. 사용자에게 "설치하세요" 안내
7. **설치 확인**: 사용자가 설치 완료 응답할 때까지 대기 후 다음 작업 진행

## 컬러 팔레트 (11색, 이 외 사용 금지)
배경=#1A1A30→#121225, 카드=#242444→#1A1A35+테두리#2E2E52, 중립=#2A2A45, 텍스트1=#E0E0EC, 텍스트2=#9090A8, 텍스트3=#707088, 배민=#2AC1BC, 쿠팡=#FFD700, ON=#2ECC71, OFF=#E74C3C, 중간=#E67E22, 수치=#FFFFFF

## UI 구조 (웹 대시보드 순서)
1. **모니터링**: 처리중 건수 + 배민(3색●)/쿠팡(2색●) 상태 + 동기화 소스(K/M/PC)
2. **조리모드**: 토글 + 목표/조리/포장 시간설정 + 실시간 주문 리스트(번호+접수시간+잔여시간+상태)
3. **게이지**: 0~10 셀, 숫자 표시, 탭→해당 구간 광고 실행 (초록=최대, 주황=중간, 빨강=최소, 현재=흰테두리), 조리모드 ON 시 하단에 조리/포장 구간 마커
4. **광고 설정**: 배민 금액(최대/중간/최소) + 토글(마스터/건수자동/쿠팡자동/배민자동) + **스케줄**(토글+시간)
5. **지연 설정**: 배민/쿠팡 목표시간, 고정조리, 임계값
6. **차트**: 건수 변동 (2시간)
7. **로그**: KDS/PosDelay/Dump 탭
8. **권한**: 앱 내에서만 표시 (접근성/알림/배터리/로그인)
- **펼침/접기**: 모든 섹션 기본 펼침, 사용자가 수동 접으면 localStorage에 저장하여 유지

## 조리모드 구조
- **목적**: 주문별 조리/포장 타이밍을 실시간 카운트다운으로 모니터링
- **설정값** (10초 단위, 초 단위 저장):
  - 목표시간(tgt): 전체 처리 한도 (기본 25분=1500초)
  - 조리시간(mid): 조리에 필요한 시간 (기본 17분=1020초)
  - 포장시간(fin): 포장에 필요한 시간 (기본 4분=240초)
- **3개 동시 카운트다운** (각각 다른 한도시간):
  - 전체(초록): `tgt - elapsed` → 전체 남은 시간 (25분 카운트)
  - 조리까지(주황): `(tgt - mid) - elapsed` → 조리 시작까지 남은 한도 (8분 카운트)
  - 포장까지(빨강): `(tgt - fin) - elapsed` → 포장 시작까지 남은 한도 (21분 카운트)
  - 0 넘으면 마이너스(-) 카운트 계속
- **상태**: 대기(초록) → 조리(주황) → 포장(빨강) → 초과(빨강)
  - 현재 구간만 색상 밝게, 나머지 반투명(55)
- **색상 우선순위**: 조리(주황)는 항상 밝게, 전체(초록)는 항상 반투명, 포장(빨강)은 해당 구간만 밝게
- **리스트**: 한줄에 한 주문 (주문번호 | 접수시간 | 상태 | 전체 | 조리 | 포장)
- **리스트 삭제**: 탭 → 5초 뒤 삭제 (재탭 시 취소), 60분 경과 시 자동 삭제
- **접수시간**: Firebase order_tracking 시간 우선, 없으면 Date.now() (oT SSE 도착 시 업데이트)
- **구버전 호환**: localStorage 값 < 100이면 분단위로 간주 → ×60 자동변환

## 광고 자동화 로직
- 건수 >= 임계값: 배민 금액축소 + 쿠팡 OFF
- 건수 < 임계값: 배민 금액원복 + 쿠팡 ON

## KDS 데이터 보정 (수신 측에서 처리)
- **원칙**: KDS 주방폰은 물리적으로 원격 (업데이트 거의 불가) → 보정은 항상 PosDelay/웹에서
- **교차검증**: count>0 + orders=[] → 0건 보정 (웹 hKds + 네이티브 FirebaseKdsReader 양쪽)
- **25분 필터**: orders 배열 있을 때 → order_tracking 시간 기준 25분 초과 주문 차감
- **30분 강제보정**: orders 배열 없을 때 → 건수 변동(count 값 변경) 없이 30분 경과 시 0으로 강제 보정
  - 기준: 주문시간이 아닌 건수 변동 시점 (orders 없어서 개별 주문시간 불명)
  - **오차 가능성**: 실제 주문이 30분 넘게 조리 중이면 잘못 0 처리 → 광고 원복됨. 다음 SSE(최대 3분)에서 count 다시 수신 시 자동 복구
- KDS 앱 업데이트를 전제로 한 해결책 금지

## Firebase 구조
- **DB**: `poskds-4ba60-default-rtdb.asia-southeast1.firebasedatabase.app`
- KDS건수=`/kds_status.json`, 설정=`/posdelay/settings.json`, 명령=`/posdelay/command.json`, 주문추적=`/posdelay/order_tracking.json`, 이상신호=`/posdelay/alert.json`, 로그=`/posdelay/log.json`

## 알림 (상태표시줄 + 이어폰 TTS)
- **원칙**: 제목 없음(`setContentTitle("")` 필수), 필요 단어만, 중복 금지
- **구현**: 모든 NotificationCompat.Builder에 `.setContentTitle("")` 명시 — 생략 시 Android가 앱 이름을 제목으로 표시함
- **기능 추가 시마다**: 해당 기능의 알림도 같은 조건으로 함께 추가
- 예: `배민광고 300원완료`, `쿠팡광고 켜기완료`, `37번 3분 지연완료`, `50번 조리`

## 설정 동기화 (로컬 최우선 + 웹 명시적 변경만 적용)
- **핵심 원칙**: 로컬(SharedPreferences)이 항상 최우선. Firebase/웹의 과거 데이터로 로컬을 덮어쓰기 절대 금지
- **SSE 초기 로드(path="/")**: 무시. 전체 데이터 적용하면 과거값이 현재 로컬을 덮어씀
- **SSE 부분 업데이트(path="/key")**: 적용. 웹에서 사용자가 명시적으로 바꾼 개별 설정만
- **앱→Firebase 설정 업로드 금지**: `uploadAllSettings()` 삭제됨 — 재생성 금지
- **앱→Firebase 업로드 허용 대상**: 광고 상태(`ad_state`), 주문 상태(`status`), KDS, 로그만

## 데이터 저장 구조
- **설정(토글/금액/게이지)**: Firebase만 (웹이 쓰고, 앱이 읽음)
- **조리모드 큐(ckQ)**: 웹 localStorage만 (실시간 카운트다운, Firebase에 넣으면 과다호출)
- **조리모드 설정(시간)**: 웹 localStorage + NativeBridge (웹 UI + 앱 TTS용)
- **섹션 접기**: 웹 localStorage (UI 상태)
- **광고 상태**: 앱→Firebase (현재 입찰/ON/OFF 표시용)
- **WebView clearCache 금지**: localStorage 날아감. 새로고침은 URL 재로드만

## WebView 로딩 관리
- **DashboardWebViewClient**: 로딩 시작/완료/실패를 Firebase 로그에 기록 (`[WebView] 로딩 완료: 1200ms` 형태)
- **서버 다운 fallback**: 마지막 성공 페이지를 `dashboard_cache.html`에 로컬 저장 → 로딩 실패 시 캐시에서 로드 + "오프라인 모드" 표시
- **캐시 없을 때**: "서버 연결 실패" 안내 + 새로고침 버튼 표시
- **새로고침(↻) 버튼**: URL 재로드만 (`clearCache` 사용 금지 — localStorage 보존)

## 이상신호 감지 (AnomalyDetector)
- 중복실행, 과다호출, 연속실패, SSE빈번재연결 → Firebase alert + 웹 표시

## 미완료/검증 필요
- 쿠팡/배민 개별 자동 ON/OFF: ● 탭 토글 (방향 합의 필요)
- 지연처리 검증 (성공 데이터 없음)
