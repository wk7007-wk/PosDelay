# PosDelay 프로젝트 규칙

## 앱 개요
배민/쿠팡 광고 자동화 + 주문 지연처리. 주문 건수에 따라 광고 입찰/ON/OFF 자동 조절.

## 개발 방침
- **웹 로그 분석 → 개선이 핵심 역할**: 웹 대시보드에서 로그를 분석하여 자동화 로직을 개선하는 구조 우선
- **네이티브 최소화, 웹 동기화 우선**: 네이티브 코드는 최대한 줄이고, 웹으로 동기화(Firebase)되는 방식 위주로 코딩
- **안정성 + 리미트 최우선**: Firebase 호출 횟수, API rate limit 등 리미트 관리와 안정성을 항상 최우선으로 고려. 기능보다 안정성이 우선

## 컬러 팔레트 (11색, 변경 시 이 외 사용 금지)
| 용도 | 색상 |
|------|------|
| 배경 그라데이션 | #1A1A30→#121225 (bg_main.xml) |
| 카드 그라데이션 | #242444→#1A1A35 + 테두리 #2E2E52 (bg_card.xml) |
| 중립 버튼/구분선 | #2A2A45 |
| 텍스트1 헤더 | #E0E0EC |
| 텍스트2 보조 | #9090A8 |
| 텍스트3 부가 | #707088 |
| 배민 | #2AC1BC (민트) |
| 쿠팡 | #FFD700 (노랑) |
| ON/켜기/최대 | #2ECC71 (초록) |
| OFF/끄기/최소 | #E74C3C (빨강) |
| 중간 | #E67E22 (주황) |
| 수치값/큰 숫자 | #FFFFFF |
| 버튼 텍스트 | #FFFFFF |

## UI 구조
- **게이지**: 0~15 셀, 모든 셀에 숫자, 탭→해당 구간 광고 직접 실행
  - 초록=켜기/최대, 주황=중간, 빨강=끄기/최소, 현재위치=흰테두리
- **임계값+금액 같은 줄**: 왼편=임계값[-][N][+], 오른편=금액[-][N원][+]
- **순서**: 쿠팡 켜기(왼)끄기(오) → 배민 최대(위)→중간→최소(아래)
- **스케줄**: 상단 한줄 (● 텍스트 탭 토글 + 시간버튼)
- **모니터링 ●**: 배민=3색(초록/주황/빨강), 쿠팡=2색(초록/빨강)
- **제거됨**: 수동실행 버튼4개, 스위치3개, 쿠팡 켜기/끄기 버튼, 업데이트 버튼, "자동" 마스터 토글
- **이동됨**: 직접열기/로그인/광고로그 → 접근성 섹션

## 광고 자동화 로직
- 주문 건수 >= 임계값 (밀릴 때):
  - **배민**: 입찰금액 축소 (BAEMIN_SET_AMOUNT)
  - **쿠팡**: 광고 종료 (COUPANG_AD_OFF)
- 주문 건수 < 임계값:
  - **배민**: 입찰금액 원복
  - **쿠팡**: 광고 재활성화 (COUPANG_AD_ON)

## Firebase 구조
- **SSE 엔드포인트**: `poskds-4ba60-default-rtdb.asia-southeast1.firebasedatabase.app`
- **KDS 건수**: `/kds_status.json` (SSE 실시간)
- **설정 동기화**: `/posdelay/settings.json`
- **명령 수신**: `/posdelay/command.json` (웹→앱)
- **주문 추적**: `/posdelay/order_tracking.json` (25분 타이머 영구저장)
- **이상신호**: `/posdelay/alert.json`
- **로그 업로드**: `/posdelay/log.json`

## 이상신호 감지 (AnomalyDetector)
- 동일 액션 30초 내 2회+ 반복
- 5분 내 광고 실행 5회+ 과다
- 같은 액션 연속 3회 실패
- SSE 10분 내 5회+ 재연결
- 알림: Firebase alert 노드 + 웹 대시보드 표시

## 알림 (상태표시줄 + 이어폰 TTS)
- **원칙**: 제목 없음, 불필요한 용어 삭제, 필요 단어만, 중복 금지
- **기능 추가 시마다**: 해당 기능의 알림도 같은 조건으로 함께 추가
- **광고 변경**:
  - `배민광고 300원완료`
  - `배민광고 최대완료`
  - `쿠팡광고 켜기완료`
  - `쿠팡광고 끄기완료`
- **지연 설정**:
  - `37번 3분 지연완료`
  - `37번 5분 지연필요` (자동 실행 전 알림)
- **조리모드**:
  - `50번 조리`
  - `50번 포장`

## PC mate_monitor
- **window_title**: "메인", **delivery_tab_id**: "198354"
- Tesseract OCR: 4x확대 + 이진화 + --psm 7
- Heartbeat: 3분마다 Gist 강제 업로드
- PrintWindow API (창 가려도 캡처), 최소화 자동 복원
- 단일 인스턴스 락 (monitor.lock PID), 로그 로테이션 500KB×3
- 시작프로그램 자동등록, .pyw 백그라운드

## 직접열기 URL
- 배민: `self.baemin.com/ad-center`
- 쿠팡: `advertising.coupangeats.com`

## UsageTracker
- `com.posdelay.app.data.UsageTracker` — 모든 버튼 클릭 카운트
- 로그 메뉴 첫 번째 항목으로 접근 가능

## 미완료/검증 필요
- 쿠팡/배민 개별 자동 ON/OFF: ● 탭 토글 (방향 합의 필요)
- 지연처리 검증 (성공 데이터 없음):
  - 쿠팡: 주문관리→스크롤→최신주문→준비지연→시간조절→확인
  - 배민: MATE앱→스크롤→조리시간추가→팝업→N분선택→확인
