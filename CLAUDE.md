# PosDelay 프로젝트 규칙

## 앱 개요
배민/쿠팡 광고 자동화 + 주문 지연처리. 주문 건수에 따라 광고 입찰/ON/OFF 자동 조절.

## 개발 방침
- **웹 로그 분석 → 개선이 핵심 역할**: 웹 대시보드에서 로그를 분석하여 자동화 로직을 개선하는 구조 우선
- **네이티브 최소화, 웹 동기화 우선**: 네이티브 코드는 최대한 줄이고, 웹으로 동기화(Firebase)되는 방식 위주로 코딩
- **안정성 + 리미트 최우선**: Firebase 호출 횟수, API rate limit 등 리미트 관리와 안정성을 항상 최우선. 기능보다 안정성 우선

## 컬러 팔레트 (11색, 이 외 사용 금지)
배경=#1A1A30→#121225, 카드=#242444→#1A1A35+테두리#2E2E52, 중립=#2A2A45, 텍스트1=#E0E0EC, 텍스트2=#9090A8, 텍스트3=#707088, 배민=#2AC1BC, 쿠팡=#FFD700, ON=#2ECC71, OFF=#E74C3C, 중간=#E67E22, 수치=#FFFFFF

## UI 구조
- **게이지**: 0~15 셀, 숫자 표시, 탭→해당 구간 광고 실행 (초록=최대, 주황=중간, 빨강=최소, 현재=흰테두리)
- **임계값+금액 같은 줄**: 왼=임계값[-][N][+], 오른=금액[-][N원][+]
- **순서**: 쿠팡 켜기(왼)끄기(오) → 배민 최대→중간→최소
- **스케줄**: 상단 한줄 (● 탭 토글 + 시간버튼)
- **모니터링 ●**: 배민=3색, 쿠팡=2색

## 광고 자동화 로직
- 건수 >= 임계값: 배민 금액축소 + 쿠팡 OFF
- 건수 < 임계값: 배민 금액원복 + 쿠팡 ON

## 25분 필터
- KDS orders 배열 유무와 관계없이 order_tracking 시간 기준으로 25분 초과 주문 차감
- order_tracking은 Firebase에 영구 저장 (앱 재설치 대비)

## Firebase 구조
- **DB**: `poskds-4ba60-default-rtdb.asia-southeast1.firebasedatabase.app`
- KDS건수=`/kds_status.json`, 설정=`/posdelay/settings.json`, 명령=`/posdelay/command.json`, 주문추적=`/posdelay/order_tracking.json`, 이상신호=`/posdelay/alert.json`, 로그=`/posdelay/log.json`

## 알림 (상태표시줄 + 이어폰 TTS)
- **원칙**: 제목 없음, 필요 단어만, 중복 금지
- **기능 추가 시마다**: 해당 기능의 알림도 같은 조건으로 함께 추가
- 예: `배민광고 300원완료`, `쿠팡광고 켜기완료`, `37번 3분 지연완료`, `50번 조리`

## WebView 로딩 관리
- **DashboardWebViewClient**: 로딩 시작/완료/실패를 Firebase 로그에 기록 (`[WebView] 로딩 완료: 1200ms` 형태)
- **서버 다운 fallback**: 마지막 성공 페이지를 `dashboard_cache.html`에 로컬 저장 → 로딩 실패 시 캐시에서 로드 + "오프라인 모드" 표시
- **캐시 없을 때**: "서버 연결 실패" 안내 + 새로고침 버튼 표시
- **로그 분석**: Firebase `/posdelay/logs.json`에서 `[WebView]` 태그로 로딩 성공률/속도/실패 원인 분석 가능
- **새로고침(↻) 버튼**: `clearCache` + 원본 URL 재로드 → 서버 복구 시 즉시 최신 페이지 로드

## 이상신호 감지 (AnomalyDetector)
- 중복실행, 과다호출, 연속실패, SSE빈번재연결 → Firebase alert + 웹 표시

## 미완료/검증 필요
- 쿠팡/배민 개별 자동 ON/OFF: ● 탭 토글 (방향 합의 필요)
- 지연처리 검증 (성공 데이터 없음)
